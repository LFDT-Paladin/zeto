# Zeto toolkit golang library

Golang implementation of Sparse Merkle Tree that is optimized for managing an append-only tree, and is able to generate proofs to be used as private inputs to a circom-based proof generator. The project also includes an end-to-end integration test that demonstrates how to use the go-rapidsnark library to generate zkSNARK proofs with WASM based circuit runtimes.

## Prerequisites

This library requires Go version **1.23**.

## Running the unit tests for the Spark Merkle Tree implementation

```console
$ make
```

## Running the integration test

The project does NOT contain some of the cryptographic materials to perform proof generations and verifications, such as the proving keys and the verification keys. You must run the [build steps](/zkp/js/README.md#build) before you can run the tests.

> You do NOT need to re-compile the circuits. Start with the step to [Generate the proving key](/zkp/js/README.md#compile-the-circuits-and-generate-verification-keys-and-solidity-libraries).

Once the proving keys and verification keys are generated, set the following environment variables

- `CIRCUITS_ROOT`: the folder that contains the WASM runtime for the circuits that are generated by the circom compiler. If you do not want to compile the circtuis yourself, a copy of them are included in the `js/lib` folder
- `PROVING_KEYS_ROOT`: the folder that contains the proving keys and verification keys

Note: you need to be running a postgres database locally before running the tests, you can run it in Docker with:

```console
docker run -d --name postgres -e POSTGRES_PASSWORD=my-secret -p 5432:5432 postgres
```

```console
$ make e2e
```

## Running the Ethereum integration test

The `eth_e2e_test.go` file contains integration tests for interacting with Ethereum networks and Zeto contracts using the Go SDK. The test suite measures performance metrics and prints out a nice summary (see below).

### Environment Variables

The test suite supports the following environment variables:

#### Required

- `ZETO_CONTRACT_ADDRESS`: Address of the deployed Zeto contract
- `ZETO_CONTRACT_NAME`: Zeto_Anon, Zeto_AnonNullifier or Zeto_AnonNullifierQurrency

#### Optional

- `ETH_RPC_URL`: JSON RPC endpoint URL (default: `http://localhost:8545`)
- `ETH_PRIVATE_KEY`: ECDSA private key for signing transactions (default: hardcoded test key)
- `NUM_RUNS`: how many iterations to run the mint/transfer cycle (default: 10)

### Running the Tests

#### Prerequisites

1. Ensure your Ethereum node (e.g., local Besu) is running

- this can be accomplished by using [`./integration-test/eth_e2e/resources/besu/docker-compose.yaml`](./integration-test/eth_e2e/resources/besu/docker-compose.yaml)

```bash
cd <project-root>/go-sdk/integration-test/eth_e2e
docker compose -f resources/besu/docker-compose.yaml up -d
```

2. Deploy a Zeto contract, using the hardhat scripts in the `solidity` folder, and note its address

```bash
# set ETH_PRIVATE_KEY_1 to match the minter key used in the test
export ETH_PRIVATE_KEY_1=ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
# set the Zeto token to deploy
export ZETO_NAME=Zeto_Anon
# deploy
cd <project-root>/solidity
npx hardhat run scripts/deploy_upgradeable.ts --network besu
Deploying fungible Zeto token: Zeto_Anon
ERC20 deployed:     0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
ZetoToken deployed: 0xB0D4afd8879eD9F52b28595d31B441D079B2Ca07
```

3. Set the required environment variables

```bash
export ETH_RPC_URL=http://localhost:8545
export ZETO_CONTRACT_ADDRESS=0xB0D4afd8879eD9F52b28595d31B441D079B2Ca07
export ZETO_CONTRACT_NAME=ZETO_Anon
# make sure this is the same key as the ETH_PRIVATE_KEY_1 used for deployment above.
# the deployer account is also the minter account, used in the test to mint Zeto tokens
export ETH_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

#### Example Commands

```bash
# Run all Ethereum tests
go test -v ./integration-test/eth_e2e -run TestEthE2ETestSuite

=== Performance STATISTICS (10 runs) ===

Witness Generation Time:
  Average: 64.58565ms
  Min:     63.034792ms
  Max:     68.816791ms

Proving Time:
  Average: 49.629037ms
  Min:     47.232792ms
  Max:     55.812583ms

Transaction Time:
  Average: 1.020575866s
  Min:     1.012903375s
  Max:     1.030475375s

Total Transaction Latency:
  Average: 1.134790554s
  Min:     1.125578917s
  Max:     1.146524958s

Transaction Gas Cost:
  Average: 352304
  Min:     352279
  Max:     352369

=== END Performance STATISTICS ===
```
