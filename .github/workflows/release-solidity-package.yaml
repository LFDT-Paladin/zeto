name: Zeto Solidity Package Release

permissions:
  contents: read
  id-token: write
on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        description: "NPM token"
        required: true
    inputs:
      ref:
        description: "Commit ref for checkout"
        required: false
        type: string
        default: ""
      package_version:
        description: "The version to publish (e.g. v1.0.0)"
        required: true
        type: string
      package_tag:
        description: 'Semicolon-separated list of tags (e.g., "latest;rc"). First tag is primary.'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      ref:
        description: "Commit ref for checkout"
        required: false
        type: string
        default: ""
      package_version:
        description: "The version to publish (e.g. v1.0.0)"
        required: true
        type: string
      package_tag:
        description: 'Semicolon-separated list of tags (e.g., "latest;rc"). First tag is primary.'
        required: true
        type: string
jobs:
  publish:
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref != '' && inputs.ref || github.ref }}

      - name: Print workflow inputs
        shell: bash
        run: |
          echo "=== Workflow Inputs ==="
          echo "ref: ${{ inputs.ref != '' && inputs.ref || github.ref }}"
          echo "package_version: ${{ inputs.package_version }}"
          echo "package_tag: ${{ inputs.package_tag }}"
          echo "======================"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        working-directory: solidity
        run: npm install

      - name: Prepare Clean Version Number
        id: prep_version
        shell: bash
        run: |
          echo "clean_version=$(echo "${{ inputs.package_version }}" | sed 's/^v//')" >> $GITHUB_OUTPUT

      - name: Update package.json name and version
        working-directory: solidity
        shell: bash
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

          # Get the current package name (without scope)
          CURRENT_NAME=$(jq -r '.name' package.json)
          # Remove any existing scope
          BASE_NAME=$(echo "$CURRENT_NAME" | sed 's/^@[^/]*\///')
          # Add the @lfdecentralizedtrust scope
          SCOPED_NAME="@lfdecentralizedtrust/${BASE_NAME}"

          # Update name (with scope) and version
          jq --arg name "$SCOPED_NAME" --arg version "${{ steps.prep_version.outputs.clean_version }}" \
            '.name = $name | .version = $version' package.json > temp.json && mv temp.json package.json

          echo "Updated package.json:"
          cat package.json

      - name: Parse NPM tags
        id: parse_tags
        shell: bash
        run: |
          TAG_LIST="${{ inputs.package_tag }}"

          # Group all writes to the GITHUB_OUTPUT file
          {
            # The first tag in the list is the primary one
            PRIMARY_TAG=$(echo "$TAG_LIST" | cut -d';' -f1)
            echo "primary_tag=$PRIMARY_TAG"

            # The rest of the tags are additional
            ADDITIONAL_TAGS=$(echo "$TAG_LIST" | cut -d';' -f2-)
            echo "additional_tags<<EOF"
            echo "$ADDITIONAL_TAGS" | tr ';' '\n'
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Publish to npm with primary tag
        continue-on-error: true
        working-directory: solidity
        shell: bash
        run: |
          set -e
          npm publish --provenance --access public --tag ${{ steps.parse_tags.outputs.primary_tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Add additional dist-tags
        if: steps.parse_tags.outputs.additional_tags != ''
        working-directory: solidity
        shell: bash
        run: |
          # Get the package name from package.json
          PACKAGE_NAME=$(jq -r '.name' package.json)
          # The version for `dist-tag add` must not have the 'v' prefix
          PACKAGE_SPEC="${PACKAGE_NAME}@${{ steps.prep_version.outputs.clean_version }}"

          echo "Adding tags for $PACKAGE_SPEC..."

          # Loop through the newline-separated list of additional tags
          while IFS= read -r tag; do
            if [[ -n "$tag" ]]; then
              echo "Adding tag: $tag"
              npm dist-tag add "$PACKAGE_SPEC" "$tag"
            fi
          done <<< "${{ steps.parse_tags.outputs.additional_tags }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
